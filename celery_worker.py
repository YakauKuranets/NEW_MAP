"""Celery worker entrypoint.

Запуск:
    celery -A celery_worker.celery worker --loglevel=info
"""

import asyncio
import logging
import os
import re
import subprocess

from app import create_app
from app.extensions import celery_app, db, redis_client

# Импорты для брутфорсера
from app.video.security_audit.async_auditor import AsyncSecurityAuditor, AsyncProxyPool, PasswordGenerator, TargetDevice
from app.video.security_audit.vuln_check import VulnerabilityScanner
from app.video.models import CameraAuditResult, HandshakeAnalysis, WifiAuditResult
from app.tasks_utils import publish_progress

flask_app = create_app()
flask_app.app_context().push()

celery = celery_app
celery.autodiscover_tasks(["app"])


def _publish_wifi_audit_event(task_id: str, payload: dict) -> None:
    channel = f"wifi_audit:{task_id}"
    try:
        import json

        redis_client.publish(channel, json.dumps(payload, ensure_ascii=False))
    except Exception:
        logging.debug("Unable to publish wifi audit event", exc_info=True)



@celery.task
def run_handshake_task(task_id, handshake_path, bssid, essid):
    """Запускает hashcat для анализа handshake и публикует прогресс."""
    with flask_app.app_context():
        analysis = HandshakeAnalysis.query.filter_by(task_id=task_id).first()
        if not analysis:
            return

        analysis.status = "running"
        analysis.progress = 0
        db.session.commit()

        wordlist = flask_app.config.get("HASHCAT_WORDLIST", "/data/wordlists/rockyou_optimized.txt")
        hccapx_path = handshake_path

        try:
            if handshake_path.endswith(".cap"):
                hccapx_path = f"{handshake_path}.hccapx"
                subprocess.run(["cap2hccapx", handshake_path, hccapx_path], check=True)

            output_file = f"/tmp/{task_id}_found.txt"
            cmd = [
                "hashcat",
                "-m", "2500",
                "-a", "0",
                "-w", "3",
                "--status",
                "--status-timer", "1",
                "-o", output_file,
                hccapx_path,
                wordlist,
            ]

            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                universal_newlines=True,
            )

            if process.stdout is not None:
                for line in process.stdout:
                    if "Progress" not in line:
                        continue
                    match = re.search(r"(\d+)/(\d+)", line)
                    if not match:
                        continue
                    current = int(match.group(1))
                    total = int(match.group(2))
                    analysis.progress = int(current / total * 100) if total else 0
                    db.session.commit()
                    publish_progress(task_id, current, total, found=False)

            process.wait()

            if process.returncode == 0:
                analysis.status = "completed"
                analysis.progress = 100
                if os.path.exists(output_file):
                    with open(output_file, "r", encoding="utf-8", errors="ignore") as f:
                        result_line = (f.readline() or "").strip()
                    if ":" in result_line:
                        password = result_line.rsplit(":", 1)[1]
                        analysis.password_found = password
                        publish_progress(task_id, 100, 100, found=True, password=password)
                    else:
                        publish_progress(task_id, 100, 100, found=False)
                else:
                    publish_progress(task_id, 100, 100, found=False)
            else:
                analysis.status = "failed"
                analysis.progress = 100
                publish_progress(task_id, 100, 100, found=False)
        except Exception:
            logging.exception("Handshake task failed for %s", task_id)
            analysis.status = "failed"
            analysis.progress = 100
            publish_progress(task_id, 100, 100, found=False)
            raise
        finally:
            db.session.commit()


@celery.task
def run_audit_task(task_id, ip, port=None, username='admin', password=None, proxy_list=None, use_vuln_check=True):
    with flask_app.app_context():
        result = CameraAuditResult.query.filter(
            CameraAuditResult.details['task_id'].astext == task_id
        ).first()
        if not result:
            return

        # Если порт не указан, используем 80 (можно добавить обнаружение позже)
        target_port = port or 80
        target = TargetDevice(ip=ip, port=target_port)

        # 1. Проверка уязвимостей
        if use_vuln_check:
            vuln = VulnerabilityScanner(target)
            vuln_result = vuln.scan()
            if vuln_result:
                result.success = True
                result.method = vuln_result['method']
                result.password_found = vuln_result.get('password', '')
                result.details = {"vuln_data": vuln_result, "status": "completed"}
                db.session.commit()
                return

        # 2. Асинхронный брутфорс
        proxy_pool = AsyncProxyPool(initial_proxies=proxy_list or [])
        gen = PasswordGenerator(vendor=target.vendor)
        auditor = AsyncSecurityAuditor(
            target=target,
            proxy_pool=proxy_pool,
            password_gen=gen,
            username=username,
            auth_type='basic',  # можно параметризовать
            concurrency=50
        )
        try:
            found = asyncio.run(auditor.run())
        except Exception as e:
            result.success = False
            result.details = {"error": f"Bruteforce failed: {str(e)}", "status": "failed"}
            db.session.commit()
            return

        result.success = bool(found)
        result.password_found = found
        result.method = 'bruteforce' if found else 'none'
        result.details = {"status": "completed"}
        db.session.commit()


@celery.task(bind=True)
def run_wifi_audit_task(self, task_id, bssid, essid, security_type, region="ru"):
    from app.video.security_audit.wifi_auditor import WifiAuditor

    auditor = WifiAuditor(region=region)

    with flask_app.app_context():
        record = WifiAuditResult.query.filter_by(task_id=task_id).first()
        if record:
            details = dict(record.details or {})
            details.update({"status": "running", "message": "Задача выполняется", "progress": max(record.progress or 1, 1)})
            record.details = details
            record.progress = max(record.progress or 1, 1)
            db.session.commit()
            _publish_wifi_audit_event(task_id, {"status": "running", "progress": int(record.progress or 1)})
            publish_progress(task_id, int(record.progress or 1), 100, found=False)

    def _progress_callback(state=None, meta=None, **kwargs):
        payload = meta or kwargs.get("meta") or {}
        try:
            self.update_state(state=state or "PROGRESS", meta=payload)
        except Exception:
            pass
        percent = int(payload.get("progress", 0) or 0)
        found = bool(payload.get("found", False))
        publish_progress(task_id, percent, 100, found=found)

    try:
        analysis = auditor.audit(
            bssid,
            essid,
            security_type,
            progress_callback=_progress_callback,
        )
    except Exception as exc:
        logging.exception("Wifi audit task failed for %s", task_id)
        with flask_app.app_context():
            record = WifiAuditResult.query.filter_by(task_id=task_id).first()
            if record:
                record.progress = 100
                record.details = {
                    "status": "failed",
                    "progress": 100,
                    "message": f"Ошибка выполнения аудита: {exc}",
                }
                db.session.commit()
                _publish_wifi_audit_event(task_id, record.details)
                publish_progress(task_id, 100, 100, found=False)
        raise

    with flask_app.app_context():
        record = WifiAuditResult.query.filter_by(task_id=task_id).first()
        if record:
            record.is_vulnerable = analysis.get('is_vulnerable', False)
            record.vulnerability_type = analysis.get('vulnerability_type')
            record.found_password = analysis.get('password')
            details = analysis.get('details', {})
            details["status"] = details.get("status", "completed")
            details["progress"] = int(details.get("progress", 100) or 100)
            record.estimated_time_seconds = int(details.get('estimatedTime', details.get('estimated_time_seconds', record.estimated_time_seconds or 0)) or 0)
            record.progress = int(details.get('progress', 100) or 100)
            if record.progress <= 0:
                record.progress = 100
            record.details = details
            db.session.commit()
            _publish_wifi_audit_event(task_id, details)
            # Финальный сигнал завершения задачи для realtime-клиентов
            publish_progress(task_id, 100, 100, found=True)
